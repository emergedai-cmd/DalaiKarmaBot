import { Command } from "commander";
import fs from "node:fs";
import path from "node:path";
import chalk from "chalk";

import { applyPlan } from "./apply-plan.js";
import { buildCleanupPlan, buildInitPlan, getPaths } from "./plan.js";
import { runDoctor } from "./doctor-cli.js";
import { readCliVersionSafe } from "./version.js";
import { runRun } from "./run-cli.js";

export async function register(program: Command) {
  // --- init ---
  program
    .command("init")
    .description("Initialize DalaiKarmaBot in the current directory")
    .option("--dry-run", "Show what would be created, but do not write anything")
    .option("--quiet", "Suppress human output (best for CI)")
    .option("--json", "Output machine-readable JSON (implies --quiet)")
    .action(async (opts: { dryRun?: boolean }) => {
      const cwd = process.cwd();
      const p = getPaths(cwd);

if (fs.existsSync(p.configPath) && !opts.dryRun) {
  console.error("❌ dalaikarmabot.config.json already exists.");
  process.exitCode = 1;
  return;
}


      const cliVersion = readCliVersionSafe();

      const config = {
        name: "dalai-karmabot",
        version: cliVersion,
        createdAt: new Date().toISOString(),
        providers: {
          // Local providers
          ollama: { baseUrl: "http://localhost:11434" },
          lmstudio: { baseUrl: "http://127.0.0.1:1234" },
          n8n: { baseUrl: "" },

          // Hosted providers (keys via env vars by default)
          groq: { baseUrl: "https://api.groq.com/openai/v1" },
          openrouter: { baseUrl: "https://openrouter.ai/api/v1" },
          deepseek: { baseUrl: "https://api.deepseek.com/v1" },
          mistral: { baseUrl: "https://api.mistral.ai/v1" }
        }
      };

      const plan = buildInitPlan(cwd);

      await applyPlan(plan, {
        dryRun: !!opts.dryRun,
        verbose: true,
        writeFileContent: async (filePath) => {
          if (filePath === p.configPath) {
            return JSON.stringify(config, null, 2) + "\n";
          }
          return "";
        }
      });

      console.log("");
      if (opts.dryRun) {
        console.log("🧪 Dry run complete (no files were created).");
      } else {
        console.log("✅ DalaiKarmaBot initialized.");
        console.log("Created:");
        console.log("  - dalaikarmabot.config.json");
      }
      console.log("");

      printNextSteps();
    });


  // --- where ---
  program
    .command("where")
    .description("Print the exact local paths DalaiKarmaBot uses in this directory")
    .action(() => {
      const p = getPaths(process.cwd());
      console.log(JSON.stringify(p, null, 2));
    });

  // --- explain ---
  program
    .command("explain")
    .description("Explain exactly what DalaiKarmaBot commands will touch")
    .action(() => {
      const cwd = process.cwd();
      const initPlan = buildInitPlan(cwd);
      const cleanupPlan = buildCleanupPlan(cwd);

      console.log("INIT would touch:");
      for (const i of initPlan) console.log(`- ${i.type}: ${i.path} (${i.description})`);

      console.log("\nCLEANUP would touch:");
      for (const i of cleanupPlan) console.log(`- ${i.type}: ${i.path} (${i.description})`);

      console.log("\nDOCTOR touches:");
      console.log("- read: dalaikarmabot.config.json");
      console.log("- network: optional HTTP GETs to configured provider baseUrls (no LLM calls)");

      console.log("\nRUN touches:");
      console.log("- read: dalaikarmabot.config.json");
      console.log("- network: HTTP POST to <ollama baseUrl>/api/chat");
      console.log("  (only when --provider ollama is used)");

    });

  // --- cleanup / self-destruct helper ---
  program
    .command("cleanup")
    .description("Remove files created by DalaiKarmaBot init (paranoia-friendly cleanup)")
    .option("--dry-run", "Show what would be removed, but do not delete anything")
    .option("-y, --yes", "Do not prompt; actually delete")
    .action(async (opts: { dryRun?: boolean; yes?: boolean }) => {
      if (!opts.dryRun && !opts.yes) {
        console.error("Refusing to delete without --yes. Try: dalaikarmabot cleanup --dry-run");
        process.exitCode = 2;
        return;
      }

      const plan = buildCleanupPlan(process.cwd());
      await applyPlan(plan, { dryRun: !!opts.dryRun, verbose: true });

      if (!opts.dryRun) console.log("🧹 Cleanup complete.");
    });

   // --- doctor ---
  program
    .command("doctor")
    .description("Validate config and check connectivity to configured endpoints")
    .option("--timeout <ms>", "Timeout per check in milliseconds", "1500")
    .action(async (opts: { timeout?: string }) => {
      const timeoutMs = Number(opts.timeout);
      await runDoctor(process.cwd(), { timeoutMs: Number.isFinite(timeoutMs) ? timeoutMs : 1500 });
    });

  // --- run ---
  program
    .command("run")
    .description("Run a minimal chat loop (first runtime path)")
    .requiredOption("--provider <name>", "Provider to use (only 'ollama' supported right now)")
    .requiredOption("--model <name>", "Model name (e.g. llama3)")
    .option("--prompt <text>", "One-shot prompt (no interactive loop)")
    .option("--timeout <ms>", "Timeout per request in milliseconds", "15000")
    .action(async (opts: { provider: string; model: string; prompt?: string; timeout?: string }) => {
      const timeoutMs = Number(opts.timeout);
      await runRun(process.cwd(), {
        provider: opts.provider,
        model: opts.model,
        prompt: opts.prompt,
        timeoutMs: Number.isFinite(timeoutMs) ? timeoutMs : 15000
      });
    });
}

function printNextSteps() {
  console.log("Next steps:");
  console.log("");

  console.log("1) Set API keys (recommended via environment variables):");
  console.log("");

  console.log("   Groq:");
  console.log("     PowerShell:  $env:GROQ_API_KEY=\"<your-key>\"");
  console.log("     Bash:        export GROQ_API_KEY=\"<your-key>\"");
  console.log("");

  console.log("   OpenRouter:");
  console.log("     PowerShell:  $env:OPENROUTER_API_KEY=\"<your-key>\"");
  console.log("     Bash:        export OPENROUTER_API_KEY=\"<your-key>\"");
  console.log("");

  console.log("   DeepSeek (free tier):");
  console.log("     PowerShell:  $env:DEEPSEEK_API_KEY=\"<your-key>\"");
  console.log("     Bash:        export DEEPSEEK_API_KEY=\"<your-key>\"");
  console.log("");

  console.log("   Mistral (free tier):");
  console.log("     PowerShell:  $env:MISTRAL_API_KEY=\"<your-key>\"");
  console.log("     Bash:        export MISTRAL_API_KEY=\"<your-key>\"");
  console.log("");

  console.log("2) Example commands:");
  console.log("");

  console.log("   Ollama (local):");
  console.log("     dalaikarmabot run --provider ollama --model llama3");
  console.log("");

  console.log("   Groq (hosted):");
  console.log("     dalaikarmabot run --provider groq --model llama-3.1-8b-instant");
  console.log("");

  console.log("   OpenRouter:");
  console.log("     dalaikarmabot run --provider openrouter --model openai/gpt-4o-mini");
  console.log("");

  console.log("   DeepSeek (free):");
  console.log("     dalaikarmabot run --provider deepseek --model deepseek-chat");
  console.log("");

  console.log("   Mistral (free):");
  console.log("     dalaikarmabot run --provider mistral --model mistral-small");
  console.log("");

  console.log("3) Validate setup:");
  console.log("   dalaikarmabot doctor");
  console.log("");
  console.log("Use `dalaikarmabot explain` to see exactly what each command touches.");
}
