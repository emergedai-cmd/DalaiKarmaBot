import fs from "node:fs/promises";
import { getPaths } from "./plan.js";

type DoctorOpts = { timeoutMs: number };

type Config = {
  providers?: {
    ollama?: { baseUrl?: string };
    lmstudio?: { baseUrl?: string };
    n8n?: { baseUrl?: string };
  };
};

function normalizeBaseUrl(u?: string): string | null {
  if (!u) return null;
  const s = u.trim();
  if (!s) return null;
  return s.replace(/\/+$/, "");
}

async function fetchWithTimeout(url: string, timeoutMs: number): Promise<{ ok: boolean; status?: number; error?: string }> {
  const ctrl = new AbortController();
  const t = setTimeout(() => ctrl.abort(), timeoutMs);

  try {
    const res = await fetch(url, { method: "GET", signal: ctrl.signal });
    return { ok: true, status: res.status };
  } catch (e: any) {
    return { ok: false, error: e?.name === "AbortError" ? "timeout" : (e?.message ?? "fetch failed") };
  } finally {
    clearTimeout(t);
  }
}

export async function runDoctor(cwd: string, opts: DoctorOpts) {
  const { configPath } = getPaths(cwd);

  console.log("ü©∫ DalaiKarmaBot doctor");
  console.log(`Config: ${configPath}`);

  let cfg: Config | null = null;
  try {
    const raw = await fs.readFile(configPath, "utf8");
    cfg = JSON.parse(raw);
  } catch {
    cfg = null;
  }

  if (!cfg) {
    console.log("‚ùå Config not found or invalid JSON. Run: dalaikarmabot init");
    process.exitCode = 2;
    return;
  }

  const ollamaBase = normalizeBaseUrl(cfg.providers?.ollama?.baseUrl);
  const lmBase = normalizeBaseUrl(cfg.providers?.lmstudio?.baseUrl);
  const n8nBase = normalizeBaseUrl(cfg.providers?.n8n?.baseUrl);

  const checks: Array<{ name: string; url: string } | null> = [
    ollamaBase ? { name: "Ollama", url: `${ollamaBase}/api/tags` } : null,
    lmBase ? { name: "LM Studio", url: `${lmBase}/v1/models` } : null,
    n8nBase ? { name: "n8n", url: `${n8nBase}` } : null
  ];

  const active = checks.filter(Boolean) as Array<{ name: string; url: string }>;

  if (active.length === 0) {
    console.log("‚ö†Ô∏è No provider baseUrl configured in config.providers.*");
    console.log("Add baseUrl values, then re-run: dalaikarmabot doctor");
    return;
  }

  let failures = 0;

  for (const c of active) {
    const r = await fetchWithTimeout(c.url, opts.timeoutMs);
    if (r.ok) {
      console.log(`‚úÖ ${c.name} reachable (${c.url}) [HTTP ${r.status}]`);
    } else {
      failures++;
      console.log(`‚ùå ${c.name} unreachable (${c.url}) [${r.error}]`);
    }
  }

  if (failures > 0) process.exitCode = 1;
  else console.log("‚úÖ All checks passed.");
}
